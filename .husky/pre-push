#!/usr/bin/env bash
. "$(dirname -- "$0")/_/husky.sh"
. "$(dirname -- "$0")/husky-utils.sh"

total_steps=3

echo ""
echo "[husky] Pre-push hook activated"
echo "[info] Running coverage, build, and size checks..."
echo ""

# Step 1: Test coverage
start_spinner "Running test coverage"
if [ "$VERBOSE" = true ]; then
  npm run coverage
else
  npm run coverage >/dev/null 2>&1
fi
stop_spinner $? "Coverage passed" "Tests failed or coverage check failed." || exit 1

# Step 2: Build
start_spinner "Building the project"
if [ "$VERBOSE" = true ]; then
  npm run build
else
  npm run build >/dev/null 2>&1
fi
stop_spinner $? "Build succeeded" "Build failed. Fix it before pushing." || exit 1

# Step 3: Bundle size
start_spinner "Checking bundle size"
if [ "$VERBOSE" = true ]; then
  npm run size
else
  npm run size >/dev/null 2>&1
fi
stop_spinner $? "Size check passed" "Bundle size exceeds threshold." || exit 1

echo ""
echo "[done] All pre-push checks passed."
